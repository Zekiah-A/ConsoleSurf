<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>ConsoleSurf Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic">
    </head>
    <body style="overflow: hidden;">
        <div id="content" style="display: none;">
            <canvas id="canvas" style="position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: -1; background-color: black; box-shadow: 0px 0px 20px black;"></canvas>
            <h3 style="position: absolute; bottom: 0px; left: 4px;">ConsoleSurf Viewer Â©Zekiah-A</h3>
            <button onclick="location.reload()" class="error" style="position: absolute; bottom: 4px; right: 4px;">Disconnect from server</button>
            <div class="card" style="position: absolute;padding: 8px;display: flex;flex-direction: column;row-gap: 4px;right: 8px;top: 8px;opacity: 0.8; width: min(300px, 100% - 8px);">
                <input id="fontSizeInput" type="number" oninput="if (+this.value > 4) fontSize = +this.value" min="4" max="96" placeholder="Console font size">
                <input id="virtualWidthInput" type="number" oninput="if (+this.value > 80) virtualWidth = +this.value" min="80" max="800" placeholder="Console width">
                <input id="canvasZoomInput" type="number" oninput="canvasZoom = this.value; applyCanvasTransform()" min="0.5" max="4" placeholder="Console zoom">
                <div style="display: flex; column-gap: 4px;">
                    <span style="align-self: center;">Console X</span>
                    <input id="canvasXInput" type="range" oninput="canvasX = -this.value; applyCanvasTransform()" style="padding: 0px; width: unset; flex-grow: 1;" min="-100" max="100" value="0">
                </div>
                <div style="display: flex; column-gap: 4px;">
                    <span style="align-self: center;">Console Y</span>
                    <input id="canvasYInput" type="range" oninput="canvasY = -this.value; applyCanvasTransform()" style="padding: 0px; width: unset; flex-grow: 1;" min="-100" max="100" value="0">
                </div>
                <button onclick="fontSizeInput.value = ''; virtualWidthInput.value = ''; canvasXInput.value = 0; canvasYInput.value = 0; canvasZoomInput.value = ''; fontSize = 12; virtualWidth = defaultVirtualWidth; canvasX = 0; canvasY = 0; canvasZoom = 1; applyCanvasTransform()">Reset all to default</button>
            </div>
        </div>

        <div id="loginPrompt" class="card" style="display: flex; flex-direction: column; row-gap: 4px;position: absolute; padding: 8px; left: 50%; top: 50%; transform: translate(-50%, -50%); width: min(400px, calc(100% - 16px));">
            <h3>Connect to remote console</h3>
            <input id="addressInput" type="text" placeholder="Server address">
            <div style="display: flex; column-gap: 4px; max-height: 40px;">
                <input id="authKeyInput" type="password" placeholder="Server authentication key">
                <button style="background-color: grey; line-height: 20px; margin: 0px !important;height: 36px;" onclick="authKeyInput.setAttribute('type', authKeyInput.getAttribute('type') == 'password' ? 'text' : 'password')">view</button>
            </div>
            <input id="consoleInput" type="text" min="7" placeholder="Server console">
            <input id="framerateInput" type="number" min="1" max="60" placeholder="Stream framerate">
            <button onclick="connect()">Connect to server</button>
        </div>

        <div class="modal">
            <input id="errorModal" type="checkbox"/>
            <label for="errorModal" class="overlay"></label>
            <article>
                <header>
                    <h3>Error</h3>
                    <label for="error_modal" class="close">&times;</label>
                </header>
                <section class="content" id="errorModalContent">
                    <!--Modal content will be placed here-->
                </section>
                <footer>
                    <label for="error_modal" class="button dangerous" id="errorModalDissmiss">
                        Go back to home and try again
                    </label>
                </footer>
            </article>
        </div>
    </body>
    <script>
        let ws = null
        const ctx = canvas.getContext("2d")
        const decoder = new TextDecoder("utf-8")
        const encoder = new TextEncoder()
        let defaultVirtualWidth = 240
        let virtualWidth = 240
        let fontSize = 12
        let firstReceive = true
        let currentX = 0
        let currentY = 0
        let frame = 0

        let modal = (text) =>
            new Promise((resolve, reject) => {
                errorModal.setAttribute("checked", true)
                errorModalContent.innerText = text
                errorModalDissmiss.addEventListener("click", () => {
                    errorModal.removeAttribute("checked")
                    resolve()
                })
            })

        const serverPacket = {
            AuthenticationError: 0,
            ConsoleNotFoundError: 1,
            Console: 2
        }

        const clientPacket = {
            Authenticate: 0,
            Input: 1
        }

        // https://github.com/torvalds/linux/blob/master/include/uapi/linux/input-event-codes.h
        // We translate inputs to linux key codes so that they can pass through ioctl nicely.
        const keyMap = {
            "Escape": 1,
            "Digit1": 2,
            "Digit2": 3,
            "Digit3": 4,
            "Digit4": 5,
            "Digit5": 6,
            "Digit6": 7,
            "Digit7": 8,
            "Digit8": 9,
            "Digit9": 10,
            "Digit0": 11,
            "Minus": 12,
            "Equal": 13,
            "Backspace": 14,
            "Tab": 15,
            "KeyQ":	16,
            "KeyW":	17,
            "KeyE":	18,
            "KeyR":	19,
            "KeyT":	20,
            "KeyY":	21,
            "KeyU":	22,
            "KeyI":	23,
            "KeyO":	24,
            "KeyP":	25,
            "BracketLeft": 26,
            "BracketRight": 27,
            "Enter": 28,
            "ControlLeft": 29,
            "KeyA":	30,
            "KeyS":	31,
            "KeyD":	32,
            "KeyF":	33,
            "KeyG":	34,
            "KeyH":	35,
            "KeyJ":	36,
            "KeyK":	37,
            "KeyL":	38,
            "Semicolon": 39,
            "Quote": 40, //dodgy
            "Backquote": 41, // dodgy
            "ShiftLeft": 42,
            "IntlBackslash": 43,
            "KeyZ": 44,
            "KeyX":	45,
            "KeyC":	46,
            "KeyV":	47,
            "KeyB":	48,
            "KeyN":	49,
            "KeyM":	50,
            "Comma":51,
            "Period": 52,
            "Slash": 53,
            "ShiftRight": 54,
            "NumpadMultiply": 55, //dodgy
            "AltLeft": 56,
            "Space": 57,
            "CapsLock": 58,
            "F1": 59,
            "F2": 60,
            "F3": 61,
            "F4": 62,
            "F5": 63,
            "F6": 64,
            "F7": 65,
            "F8": 66,
            "F9": 67,
            "F10": 68,
            "NumLock": 69,
            "ScrollLock": 70,
            "Numpad7": 71,
            "Numpad8": 72,
            "Numpad9": 73,
            "NumpadSubtract": 74,
            "Numpad4": 75,
            "Numpad5": 76,
            "Numpad6": 77,
            "NumpadAdd": 78,
            "Numpad1": 79,
            "Numpad2": 80,
            "Numpad3": 81,
            "Numpad0": 82,
            "NumpadDecimal": 83
        }

        function connect() {
            localStorage.server = addressInput.value
            localStorage.authKey = authKeyInput.value
            localStorage.console = consoleInput.value
            localStorage.framerate = framerateInput.value

            ws = new WebSocket(addressInput.value)
            
            ws.onopen = () => {
                let buffer = encoder.encode("_" + authKeyInput.value + "_" + consoleInput.value)
                buffer[0] = clientPacket.Authenticate
                buffer[37] = +framerateInput.value
                ws.send(buffer)

                loginPrompt.style.display = "none"
                content.style.display = "block"
                document.body.style.backgroundColor = "darkGrey"
            }

            ws.onmessage = async ({data}) => {
                data = new DataView(await data.arrayBuffer())

                if (data.getUint8(0) == serverPacket.AuthenticationError) {
                    modal("Could not authenticate with provided key.. try again")
                        .then(() => location.reload())
                }
                else if (data.getUint8(0) == serverPacket.ConsoleNotFoundError) {
                    modal("Could not locate desired virtual console, valid consoles include: "
                        + decoder.decode(data.buffer.slice(1)))
                        .then(() => location.reload())
                    return
                }

                // Virtual consoles will start with a vidbuf struct (unsigned char vidbuf_lines; unsigned char vidbuf_columns;
                // unsigned char vidbuf_curcolumn; unsigned char vidbuf_curline;). We use this to get a little info about the console.
                if (firstReceive) {
                    defaultVirtualWidth = data.getUint8(2)
                    virtualWidth = data.getUint8(2)
                    firstReceive = false
                }

                let buffer = decoder.decode(data.buffer.slice(5))
                buffer = buffer.replaceAll("\u0007", "") // Strip bell

                // Draw to canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height)
                ctx.font = fontSize + "px Menlo, Consolas, monospace"
                ctx.fillStyle = "white"

                for (i = 0; i < buffer.length; i += virtualWidth) {
                    let chunk = buffer.slice(i, i + virtualWidth)
                    ctx.fillText(chunk, 0, (i / virtualWidth) * fontSize + fontSize) // i / virtualWidth = row
                }

                // We use the vidbuf info to draw a cursor at the current text position (with blink)
                if ((frame % framerateInput.value) > framerateInput.value / 2) {
                    ctx.fillRect(data.getUint8(3) * fontSize, data.getUint8(4) * fontSize, fontSize / 6, fontSize)
                }
                frame++
            }

            ws.onclose = () => {
                modal("Console connection closed unexpectedly")
                    .then(() => location.reload())
            }

            ws.onerror = (error) => {
                modal("Console connection experienced error: " + error.toString())
                    .then(() => location.reload())
            }
        }

        addEventListener('keydown', (event) => {
            if (event.target != document.body || keyMap[event.code] == null) {
                return
            }

            let buffer = new Uint8Array(2)
            buffer[0] = clientPacket.Input
            buffer[1] = keyMap[event.code]

            ws.send(buffer)
        })
        
        let canvasX = 0
        let canvasY = 0
        let canvasZoom = 1
        function applyCanvasTransform() {
            canvas.style.transform = `translate(${canvasX}%, ${canvasY}%) scale(${canvasZoom})`
        }

        function resizeCanvas() {
            canvas.width = innerWidth
            canvas.height = innerHeight
        }
        addEventListener("resize", resizeCanvas)
        resizeCanvas()

        addressInput.value = localStorage.server || ""
        authKeyInput.value = localStorage.authKey || ""
        consoleInput.value = localStorage.console || ""
        framerateInput.value = localStorage.framerate || ""
    </script>
</html>
