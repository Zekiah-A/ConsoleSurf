<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>ConsoleSurf Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic">
    </head>
    <body style="overflow: hidden;">
        <div id="content" style="display: none;">
            <canvas id="canvas" style="position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: -1; background-color: black; box-shadow: 0px 0px 20px black;"></canvas>
            <h3 style="position: absolute; bottom: 0px; left: 4px;">ConsoleSurf Viewer Â©Zekiah-A</h3>
            <button onclick="location.reload()" class="error" style="position: absolute; bottom: 4px; right: 4px;">Disconnect from server</button>
            <div class="card" style="position: absolute;padding: 8px;display: flex;flex-direction: column;row-gap: 4px;right: 8px;top: 8px;opacity: 0.8; width: min(300px, 100% - 8px);">
                <input id="fontSizeInput" type="number" oninput="if (+this.value > 4) fontSize = +this.value" min="4" max="96" placeholder="Console font size">
                <input id="virtualWidthInput" type="number" oninput="if (+this.value > 80) virtualWidth = +this.value" min="80" max="800" placeholder="Console width">
                <input id="canvasZoomInput" type="number" oninput="canvasZoom = this.value; applyCanvasTransform()" min="0.5" max="4" placeholder="Console zoom">
                <div style="display: flex; column-gap: 4px;">
                    <span style="align-self: center;">Console X</span>
                    <input id="canvasXInput" type="range" oninput="canvasX = -this.value; applyCanvasTransform()" style="padding: 0px; width: unset; flex-grow: 1;" min="-100" max="100" value="0">
                </div>
                <div style="display: flex; column-gap: 4px;">
                    <span style="align-self: center;">Console Y</span>
                    <input id="canvasYInput" type="range" oninput="canvasY = -this.value; applyCanvasTransform()" style="padding: 0px; width: unset; flex-grow: 1;" min="-100" max="100" value="0">
                </div>
                <button onclick="fontSizeInput = ''; virtualWidthInput.value = ''; canvasXInput.value = 0; canvasYInput.value = 0; canvasZoomInput.value = ''; fontSize = 12; virtualWidth = 240; canvasX = 0; canvasY = 0; canvasZoom = 1; applyCanvasTransform()">Reset all to default</button>
            </div>
        </div>

        <div id="loginPrompt" class="card" style="display: flex; flex-direction: column; row-gap: 4px;position: absolute; padding: 8px; left: 50%; top: 50%; transform: translate(-50%, -50%); width: min(400px, calc(100% - 16px));">
            <h3>Connect to remote console</h3>
            <input id="addressInput" type="text" placeholder="Server address">
            <div style="display: flex; column-gap: 4px; max-height: 40px;">
                <input id="authKeyInput" type="password" placeholder="Server authentication key">
                <button style="background-color: grey; line-height: 20px; margin: 0px !important;height: 36px;" onclick="authKeyInput.setAttribute('type', authKeyInput.getAttribute('type') == 'password' ? 'text' : 'password')">view</button>
            </div>
            <input id="consoleInput" type="text" min="7" placeholder="Server console">
            <input id="framerateInput" type="number" min="1" max="60" placeholder="Stream framerate">
            <button onclick="connect()">Connect to server</button>
        </div>
    </body>
    <script>
        let ws = null
        const ctx = canvas.getContext("2d")
        const decoder = new TextDecoder("utf-8")
        const encoder = new TextEncoder()
        let virtualWidth = 240
        let fontSize = 12

        const serverPacket = {
            AuthenticationError: 0,
            ConsoleNotFoundError: 1,
            Console: 2
        }

        const clientPacket = {
            Authenticate: 0,
            Input: 1
        }

        function connect() {
            localStorage.server = addressInput.value
            localStorage.authKey = authKeyInput.value
            localStorage.console = consoleInput.value
            localStorage.framerate = framerateInput.value

            ws = new WebSocket(addressInput.value)
            
            ws.onopen = () => {
                let buffer = encoder.encode("_" + authKeyInput.value + "_" + consoleInput.value)
                buffer[0] = clientPacket.Authenticate
                buffer[37] = +framerateInput.value
                ws.send(buffer)

                loginPrompt.style.display = "none"
                content.style.display = "block"
                document.body.style.backgroundColor = "darkGrey"
            }

            ws.onmessage = async ({data}) => {
                data = new DataView(await data.arrayBuffer())

                if (data.getUint8(0) == serverPacket.AuthenticationError) {
                    alert("Could not authenticate with provided key.. try again")
                    location.reload()
                }
                else if (data.getUint8(0) == serverPacket.ConsoleNotFoundError) {
                    alert("Could not locate desired virtual console, valid consoles include: "
                        + decoder.decode(data.buffer.slice(1)))
                    location.reload()
                    return
                }

                let buffer = decoder.decode(data.buffer.slice(1))
                buffer = buffer.replaceAll("\u0007", "") // Strip bell

                // Draw to canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height)
                ctx.font = fontSize + "px Menlo, Consolas, monospace"
                ctx.fillStyle = "white"

                for (i = 0; i < buffer.length; i += virtualWidth) {
                    let chunk = buffer.slice(i, i + virtualWidth)
                    ctx.fillText(chunk, 0, (i / virtualWidth) * fontSize + fontSize) // row * fontSize
                }
            }

            ws.closed = () => {
                alert("Console connection closed unexpectedly")
                location.reload()
            }

            ws.onerror = (error) => {
                console.error(error)
            }
        }

        addEventListener('keydown', (event) => {
            if (event.target != document.body) {
                return
            }

            let buffer = new ArrayBuffer(2)
            buffer[0] = clientPacket.Input
            buffer[1] = event.keyCode

            console.log(buffer)
            ws.send(buffer)
        })
        
        let canvasX = 0
        let canvasY = 0
        let canvasZoom = 1
        function applyCanvasTransform() {
            canvas.style.transform = `translate(${canvasX}%, ${canvasY}%) scale(${canvasZoom})`
        }

        function resizeCanvas() {
            canvas.width = innerWidth
            canvas.height = innerHeight
        }
        addEventListener("resize", resizeCanvas)
        resizeCanvas()

        addressInput.value = localStorage.server || ""
        authKeyInput.value = localStorage.authKey || ""
        consoleInput.value = localStorage.console || ""
        framerateInput.value = localStorage.framerate || ""
    </script>
</html>
